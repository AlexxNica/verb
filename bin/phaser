#!/usr/bin/env node

'use strict';

process.title = 'phaser';

// Node.js
var path = require('path');

// node_modules
var chalk = require('chalk');
var glob = require('globule');
var file = require('fs-utils');
var program = require('commander');
var prompt = require('prompt');

// Local libs
var phaser = require('../index');
var pkg = require('../package.json');
var version = pkg.version;

// CLI

program
  .version(version)
  .usage('[options] [dir]')
  .option('-f, --file', 'build a specific file.')
  .option('-d, --directory', 'build an entire directory, globbing patterns optional.')
  .option('-v, --verbose', 'verbose logging')
  .parse(process.argv);

// Messages

var success = chalk.green;
var warn    = chalk.yellow;
var error   = chalk.red;

// Defaults
var config = {readme: 'README.tmpl.md'};
var supplied = {};

function render(filepath) {
  var template = path.join(filepath, config.readme);

  // Check for a README template before continuing
  if (!file.exists(template)) {
    console.log(error('README.tmpl.md not found.'));
    return;
  }

  // Run phaser
  var content = file.readFileSync(template);

  file.writeFileSync('README.md', phaser.process(content));
  console.log('\n>> README rendered.\n' + success('>> Completed successfully.'));
};

// Phaser

if(program.directory) {
  glob.find(program.rawArgs[3] + '/*', {filter: 'isFile'}).map(function(task) {
    require(path.resolve(task));
    console.log(success('Success\n'));
  });
} else if(program.file) {
  glob.find(program.rawArgs[3], {filter: 'isFile'}).map(function(task) {
    require(path.resolve(task));
    console.log(success('Success\n'));
  });
} else {

  // If no path is specified, ask for one.
  if (process.argv.length < 3) {
    try {
      render('docs');
    } catch(e) {
      prompt.message = 'Please supply a source directory';
      prompt.start();
      prompt.get(['path'], function (err, result) {
        render(result.path);
      });
    }
  } else {
    try {
      render(process.argv[2]);
    } catch(e) {
      console.warn(error('Phaser cannot find a README template.', e));
    }
  }
}

